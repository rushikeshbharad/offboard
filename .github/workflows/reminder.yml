name: Reminder

on:
  workflow_dispatch:
  schedule:
    - cron: "30 2 * * *"
    - cron: "30 6 * * *"
    - cron: "30 11 * * *"

jobs:
  read-sheet:
    runs-on: ubuntu-latest
    steps:
      - name: Download sheet
        run: |
          SHEET_URL="${{ secrets.OFFBOARD_SHEET }}"
          # Convert Google Sheet URL to export format if needed
          if [[ "$SHEET_URL" == *"docs.google.com"* ]]; then
            SHEET_URL=$(echo "$SHEET_URL" | sed -E 's|/edit.*|/export?format=csv|; s|/pubhtml.*|/pub?output=csv|')
          fi
          curl -L "$SHEET_URL" -o sheet.csv
          
          if grep -q "<!DOCTYPE html" sheet.csv; then
            echo "Error: Downloaded file is HTML. Check OFFBOARD_SHEET secret."
            exit 1
          fi

      - name: Extract titles and set output
        id: extract
        run: |
          titles=$(awk -F',' 'NR>1 && $2 <= strftime("%Y-%m-%d") { printf "%%0A â€¢ %s", $1 }' sheet.csv)
          
          echo "titles=$titles" >> "$GITHUB_OUTPUT"

      - name: Send success notification
        env:
          TITLES: ${{ steps.extract.outputs.titles }}
        run: |
          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="Pending chores:%0A$TITLES"
